<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°ç³»ç»Ÿæ•°æ®åº“æµ‹è¯• - step1-1</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 10px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    .section h2 {
      margin-top: 0;
      color: #555;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #2563eb;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    textarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      resize: vertical;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #3b82f6;
      padding-left: 10px;
      font-size: 13px;
    }
    .checklist {
      margin: 15px 0;
    }
    .checklist-item {
      padding: 8px;
      margin: 5px 0;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .checklist-item.completed {
      background: #d4edda;
    }
    .checklist-item span {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ–°ç³»ç»Ÿæ•°æ®åº“æµ‹è¯• - step1-1</h1>

    <div class="section">
      <h2>âœ… å®Œæˆæ¸…å•</h2>
      <div class="checklist">
        <div class="checklist-item" id="check-1">
          <span>â–¡</span> åˆ›å»º pages_v2 è¡¨ç»“æ„
        </div>
        <div class="checklist-item" id="check-2">
          <span>â–¡</span> æ·»åŠ ç´¢å¼•
        </div>
        <div class="checklist-item" id="check-3">
          <span>â–¡</span> æµ‹è¯•æ•°æ®åº“è¿æ¥
        </div>
      </div>
    </div>

    <div class="section">
      <h2>1. æ•°æ®åº“è¡¨ç»“æ„</h2>
      <p>è¯·åœ¨ Supabase æ§åˆ¶å°çš„ SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹ SQL è„šæœ¬åˆ›å»º pages_v2 è¡¨ï¼š</p>
      <textarea id="sqlScript" readonly></textarea>
      <div style="margin-top: 10px;">
        <button onclick="copySQL()">ğŸ“‹ å¤åˆ¶SQL</button>
        <a href="https://supabase.com/dashboard/project/liiibkgarmcqwgcvojrt/sql" target="_blank">
          <button>ğŸ”— æ‰“å¼€Supabase SQLç¼–è¾‘å™¨</button>
        </a>
      </div>
    </div>

    <div class="section">
      <h2>2. æµ‹è¯•è¿æ¥å’ŒCRUDæ“ä½œ</h2>
      <p>åŠ è½½ä»¥ä¸‹è„šæœ¬è¿›è¡Œæµ‹è¯•ï¼š</p>
      <div style="margin: 15px 0;">
        <button onclick="loadSupabaseConfig()">åŠ è½½Supabaseé…ç½®</button>
        <button onclick="loadNewSystemDB()" disabled id="btn-load-db">åŠ è½½NewSystemDB</button>
        <button onclick="testConnection()" disabled id="btn-test-conn">æµ‹è¯•è¿æ¥</button>
      </div>
      <div style="margin: 15px 0;">
        <button onclick="testCreatePage()" disabled id="btn-create">åˆ›å»ºæµ‹è¯•é¡µé¢</button>
        <button onclick="testGetPages()" disabled id="btn-get">è·å–é¡µé¢åˆ—è¡¨</button>
        <button onclick="testUpdatePage()" disabled id="btn-update">æ›´æ–°é¡µé¢</button>
        <button onclick="testDeletePage()" disabled id="btn-delete">åˆ é™¤é¡µé¢</button>
      </div>
    </div>

    <div class="section">
      <h2>3. æµ‹è¯•æ—¥å¿—</h2>
      <div id="status"></div>
      <div id="log"></div>
    </div>
  </div>

  <!-- åŠ è½½ Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    let testPageId = null;
    let testProjectId = 'test-project-001';
    let testRoleId = 'test-role-001';

    // æ˜¾ç¤ºçŠ¶æ€
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.style.borderLeftColor = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#3b82f6';
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
    }

    // æ›´æ–°æ¸…å•çŠ¶æ€
    function updateChecklist(id, completed) {
      const item = document.getElementById(id);
      if (completed) {
        item.classList.add('completed');
        item.querySelector('span').textContent = 'âœ“';
      }
    }

    // åŠ è½½SQLè„šæœ¬
    function loadSQLScript() {
      fetch('srcnew/database/create_pages_v2_table.sql')
        .then(response => response.text())
        .then(text => {
          document.getElementById('sqlScript').value = text;
          addLog('SQLè„šæœ¬åŠ è½½æˆåŠŸ', 'success');
        })
        .catch(error => {
          addLog('SQLè„šæœ¬åŠ è½½å¤±è´¥: ' + error, 'error');
        });
    }

    // å¤åˆ¶SQL
    function copySQL() {
      const sqlScript = document.getElementById('sqlScript');
      sqlScript.select();
      document.execCommand('copy');
      addLog('SQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }

    // åŠ è½½Supabaseé…ç½®
    function loadSupabaseConfig() {
      addLog('æ­£åœ¨åŠ è½½Supabaseé…ç½®...');
      const script = document.createElement('script');
      script.src = 'src/config/supabase.js';
      script.onload = () => {
        addLog('Supabaseé…ç½®åŠ è½½æˆåŠŸ', 'success');
        document.getElementById('btn-load-db').disabled = false;
      };
      script.onerror = () => {
        addLog('Supabaseé…ç½®åŠ è½½å¤±è´¥', 'error');
      };
      document.body.appendChild(script);
    }

    // åŠ è½½NewSystemDB
    function loadNewSystemDB() {
      addLog('æ­£åœ¨åŠ è½½NewSystemDB...');
      const script = document.createElement('script');
      script.src = 'srcnew/utils/NewSystemDB.js';
      script.onload = () => {
        addLog('NewSystemDBåŠ è½½æˆåŠŸ', 'success');
        addLog('window.newSystemDBå·²æŒ‚è½½', 'info');
        document.getElementById('btn-test-conn').disabled = false;
      };
      script.onerror = () => {
        addLog('NewSystemDBåŠ è½½å¤±è´¥', 'error');
      };
      document.body.appendChild(script);
    }

    // æµ‹è¯•è¿æ¥
    async function testConnection() {
      try {
        addLog('æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...');

        // æ£€æŸ¥Supabaseå®¢æˆ·ç«¯
        if (!window.supabaseClient) {
          throw new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
        }

        // å°è¯•æŸ¥è¯¢pages_v2è¡¨
        const { data, error } = await window.supabaseClient
          .from('pages_v2')
          .select('count')
          .limit(1);

        if (error) {
          if (error.code === '42P01') {
            throw new Error('è¡¨ pages_v2 ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºè¡¨');
          }
          throw error;
        }

        addLog('æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');
        updateChecklist('check-3', true);
        showStatus('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');

        // å¯ç”¨CRUDæµ‹è¯•æŒ‰é’®
        document.getElementById('btn-create').disabled = false;
        document.getElementById('btn-get').disabled = false;

        // æ£€æŸ¥è¡¨ç»“æ„æ˜¯å¦å®Œæ•´
        addLog('è¡¨ç»“æ„éªŒè¯é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹CRUDæµ‹è¯•', 'info');

      } catch (error) {
        addLog('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
        showStatus('âŒ ' + error.message, 'error');
      }
    }

    // æµ‹è¯•åˆ›å»ºé¡µé¢
    async function testCreatePage() {
      try {
        addLog('æ­£åœ¨åˆ›å»ºæµ‹è¯•é¡µé¢...');

        const page = {
          id: `test-page-${Date.now()}`,
          projectId: testProjectId,
          roleId: testRoleId,
          name: 'æµ‹è¯•é¡µé¢',
          category: 'å›ºå®šé¡µ',
          level: 0,
          layout: { width: 1200, height: 800 },
          css: { global: '', container: '.canvas-container', block: {} },
          components: []
        };

        const result = await window.newSystemDB.createPage(page);
        testPageId = result.id;

        addLog('é¡µé¢åˆ›å»ºæˆåŠŸï¼ŒID: ' + testPageId, 'success');
        document.getElementById('btn-update').disabled = false;
        document.getElementById('btn-delete').disabled = false;

        updateChecklist('check-1', true);
        updateChecklist('check-2', true);

      } catch (error) {
        addLog('åˆ›å»ºé¡µé¢å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æµ‹è¯•è·å–é¡µé¢
    async function testGetPages() {
      try {
        addLog('æ­£åœ¨è·å–é¡µé¢åˆ—è¡¨...');

        const pages = await window.newSystemDB.getPagesByRoleId(testProjectId, testRoleId);

        addLog(`è·å–åˆ° ${pages.length} ä¸ªé¡µé¢`, 'success');
        pages.forEach(page => {
          addLog(`  - ${page.name} (${page.id})`, 'info');
        });

      } catch (error) {
        addLog('è·å–é¡µé¢å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æµ‹è¯•æ›´æ–°é¡µé¢
    async function testUpdatePage() {
      try {
        addLog('æ­£åœ¨æ›´æ–°é¡µé¢...');

        const updated = await window.newSystemDB.updatePage(testPageId, {
          name: 'æµ‹è¯•é¡µé¢ï¼ˆå·²æ›´æ–°ï¼‰',
          designProgress: 50
        });

        addLog('é¡µé¢æ›´æ–°æˆåŠŸ', 'success');
        addLog(`æ–°åç§°: ${updated.name}, è¿›åº¦: ${updated.designProgress}%`, 'info');

      } catch (error) {
        addLog('æ›´æ–°é¡µé¢å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æµ‹è¯•åˆ é™¤é¡µé¢
    async function testDeletePage() {
      try {
        addLog('æ­£åœ¨åˆ é™¤é¡µé¢...');

        await window.newSystemDB.deletePage(testPageId);

        addLog('é¡µé¢åˆ é™¤æˆåŠŸ', 'success');
        testPageId = null;

      } catch (error) {
        addLog('åˆ é™¤é¡µé¢å¤±è´¥: ' + error.message, 'error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    window.onload = function() {
      loadSQLScript();
      addLog('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·æŒ‰æ­¥éª¤æ“ä½œ', 'info');
    };
  </script>
</body>
</html>
