<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DND2 - Phase 1 æµ‹è¯• (db.jsæ‹†åˆ†)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { color: #333; }
    .test-section {
      background: #f5f5f5;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
    }
    .success { color: green; }
    .error { color: red; }
    .api-list {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
      font-size: 12px;
    }
    .api-item { 
      padding: 3px 6px; 
      background: #e0e0e0; 
      border-radius: 4px;
    }
    .api-item.ok { background: #c8e6c9; }
    .api-item.missing { background: #ffcdd2; }
    button {
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #1565c0; }
    #log {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ DND2 Phase 1 æµ‹è¯•</h1>
  <p>db.js (1,590è¡Œ) â†’ 8ä¸ªæ–‡ä»¶ (1,868è¡Œ)</p>
  
  <div class="test-section">
    <h3>1. æ¨¡å—åŠ è½½æ£€æŸ¥</h3>
    <div id="loadCheck">æ­£åœ¨æ£€æŸ¥...</div>
  </div>
  
  <div class="test-section">
    <h3>2. APIå®Œæ•´æ€§æ£€æŸ¥ (58ä¸ªAPI)</h3>
    <div id="apiCheck" class="api-list"></div>
    <p id="apiSummary"></p>
  </div>
  
  <div class="test-section">
    <h3>3. åŠŸèƒ½æµ‹è¯•</h3>
    <button onclick="testInit()">æµ‹è¯•åˆå§‹åŒ–</button>
    <button onclick="testProject()">æµ‹è¯•é¡¹ç›®CRUD</button>
    <button onclick="testAll()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
  </div>
  
  <div class="test-section">
    <h3>4. æµ‹è¯•æ—¥å¿—</h3>
    <div id="log">ç­‰å¾…æµ‹è¯•...</div>
  </div>

  <!-- åŠ è½½æ‹†åˆ†åçš„dbæ¨¡å— -->
  <script src="./src/utils/db/index.js"></script>
  <script src="./src/utils/db/projectOperations.js"></script>
  <script src="./src/utils/db/roleOperations.js"></script>
  <script src="./src/utils/db/fieldOperations.js"></script>
  <script src="./src/utils/db/formOperations.js"></script>
  <script src="./src/utils/db/flowOperations.js"></script>
  <script src="./src/utils/db/pageOperations.js"></script>
  <script src="./src/utils/db/statisticsOperations.js"></script>

  <script>
    // æ—¥å¿—å‡½æ•°
    function log(msg, type = 'info') {
      const logDiv = document.getElementById('log');
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      logDiv.textContent += `${prefix} ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // æ¸…ç©ºæ—¥å¿—
    function clearLog() {
      document.getElementById('log').textContent = '';
    }

    // APIåˆ—è¡¨ (æ¥è‡ªçº²é¢†)
    const expectedAPIs = [
      // åˆå§‹åŒ–
      'init',
      // é¡¹ç›®
      'addProject', 'getAllProjects', 'getProjectById', 'updateProject', 'deleteProject',
      // è§’è‰²
      'addRole', 'updateRole', 'deleteRole', 'getRolesByProjectId', 'getRoleById', 'generateRoleId',
      // å­—æ®µ
      'addField', 'updateField', 'deleteField', 'getFieldsByProjectId', 'generateFieldId', 
      'checkFieldNameExists', 'updateFieldRelatedForms', 'batchUpdateFieldRelatedForms',
      // è¡¨å•
      'addForm', 'updateForm', 'deleteForm', 'getFormsByProjectId', 'generateFormId', 'buildFormStructure',
      // è¡¨å•æ•°æ®
      'addFormData', 'getFormDataList', 'getFormDataById', 'updateFormData', 'deleteFormData',
      // æ•°æ®æµç¨‹
      'addDataFlow', 'updateDataFlow', 'deleteDataFlow', 'getDataFlowsByProjectId', 
      'getDataFlowById', 'generateDataFlowId', 'saveDataFlowDesign',
      // é¡µé¢
      'addPage', 'updatePage', 'deletePage', 'getPagesByRoleId', 'generatePageId', 'checkPageNameExists',
      // å˜é‡
      'addVariable', 'updateVariable', 'deleteVariable', 'getVariables', 'getVariableById',
      'generateVariableId', 'incrementVariableId', 'addVariableUsage', 'removeVariableUsage',
      'checkNodeDeletable', 'cleanupFlowVariables', 'getVariablesBySourceType', 'traceVariableSource',
      // ç»Ÿè®¡
      'addStatistic', 'updateStatistic', 'deleteStatistic', 'getStatisticsByProjectId', 
      'getStatisticById', 'updateStatisticData'
    ];

    // 1. æ£€æŸ¥æ¨¡å—åŠ è½½
    function checkModuleLoad() {
      const checkDiv = document.getElementById('loadCheck');
      if (typeof window.dndDB !== 'undefined' && window.dndDB !== null) {
        checkDiv.innerHTML = '<span class="success">âœ… window.dndDB å·²åˆ›å»º</span>';
        return true;
      } else {
        checkDiv.innerHTML = '<span class="error">âŒ window.dndDB æœªåˆ›å»º</span>';
        return false;
      }
    }

    // 2. æ£€æŸ¥APIå®Œæ•´æ€§
    function checkAPIs() {
      const apiDiv = document.getElementById('apiCheck');
      const summaryDiv = document.getElementById('apiSummary');
      let okCount = 0;
      let html = '';

      expectedAPIs.forEach(api => {
        const exists = typeof window.dndDB[api] === 'function';
        if (exists) okCount++;
        html += `<div class="api-item ${exists ? 'ok' : 'missing'}">${api}</div>`;
      });

      apiDiv.innerHTML = html;
      summaryDiv.innerHTML = okCount === expectedAPIs.length 
        ? `<span class="success">âœ… å…¨éƒ¨ ${okCount}/${expectedAPIs.length} ä¸ªAPIå·²å®ç°</span>`
        : `<span class="error">âŒ ${okCount}/${expectedAPIs.length} ä¸ªAPIå·²å®ç°ï¼Œç¼ºå°‘ ${expectedAPIs.length - okCount} ä¸ª</span>`;
    }

    // æµ‹è¯•åˆå§‹åŒ–
    async function testInit() {
      clearLog();
      log('å¼€å§‹æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–...');
      try {
        await window.dndDB.init();
        log('æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ', 'success');
      } catch (e) {
        log('åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
      }
    }

    // æµ‹è¯•é¡¹ç›®CRUD
    async function testProject() {
      clearLog();
      log('å¼€å§‹æµ‹è¯•é¡¹ç›®CRUD...');
      
      try {
        // åˆå§‹åŒ–
        await window.dndDB.init();
        log('æ•°æ®åº“å·²åˆå§‹åŒ–', 'success');

        // åˆ›å»ºé¡¹ç›®
        const project = await window.dndDB.addProject({
          id: 'TEST-' + Date.now(),
          name: 'æµ‹è¯•é¡¹ç›®',
          description: 'Phase 1 æµ‹è¯•',
          status: 'active',
          createdAt: new Date().toISOString()
        });
        log('åˆ›å»ºé¡¹ç›®æˆåŠŸ: ' + project.id, 'success');
        log('  - é»˜è®¤è§’è‰²æ•°: ' + project.roles.length);
        log('  - ç³»ç»Ÿç®¡ç†å‘˜: ' + project.roles[0].name);

        // è·å–é¡¹ç›®
        const fetched = await window.dndDB.getProjectById(project.id);
        log('è·å–é¡¹ç›®æˆåŠŸ: ' + fetched.name, 'success');

        // æ›´æ–°é¡¹ç›®
        fetched.name = 'æ›´æ–°åçš„æµ‹è¯•é¡¹ç›®';
        await window.dndDB.updateProject(fetched);
        log('æ›´æ–°é¡¹ç›®æˆåŠŸ', 'success');

        // è·å–æ‰€æœ‰é¡¹ç›®
        const all = await window.dndDB.getAllProjects();
        log('è·å–æ‰€æœ‰é¡¹ç›®æˆåŠŸï¼Œå…± ' + all.length + ' ä¸ª', 'success');

        // åˆ é™¤é¡¹ç›®
        await window.dndDB.deleteProject(project.id);
        log('åˆ é™¤é¡¹ç›®æˆåŠŸ', 'success');

        log('\né¡¹ç›®CRUDæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');
      } catch (e) {
        log('æµ‹è¯•å¤±è´¥: ' + e.message, 'error');
        console.error(e);
      }
    }

    // è¿è¡Œæ‰€æœ‰æµ‹è¯•
    async function testAll() {
      await testInit();
      log('\n--- åˆ†éš”çº¿ ---\n');
      await testProject();
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ£€æŸ¥
    window.onload = function() {
      checkModuleLoad();
      if (window.dndDB) {
        checkAPIs();
      }
    };
  </script>
</body>
</html>
