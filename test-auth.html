<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DND ç”¨æˆ·è®¤è¯æ¨¡å—æµ‹è¯•</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f3f4f6;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- è®¤è¯æœåŠ¡ -->
  <script src="./src/auth/authService.js"></script>
  
  <!-- è®¤è¯ç»„ä»¶ -->
  <script type="text/babel" src="./src/auth/AuthBlock.jsx"></script>
  
  <!-- æµ‹è¯•åº”ç”¨ -->
  <script type="text/babel">
    function TestApp() {
      const [logs, setLogs] = React.useState([]);
      const [user, setUser] = React.useState(null);

      // æ·»åŠ æ—¥å¿—
      const addLog = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        setLogs(prev => [...prev, { timestamp, message, type }]);
      };

      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      React.useEffect(() => {
        const checkUser = async () => {
          const currentUser = await window.authService.getCurrentUser();
          setUser(currentUser);
          if (currentUser) {
            addLog(`å½“å‰å·²ç™»å½•: ${currentUser.email}`, 'success');
          } else {
            addLog('å½“å‰æœªç™»å½•', 'info');
          }
        };
        checkUser();

        // ç›‘å¬çŠ¶æ€å˜åŒ–
        const unsubscribe = window.authService.onAuthStateChange((event, userData) => {
          setUser(userData);
          addLog(`è®¤è¯çŠ¶æ€å˜åŒ–: ${event}`, 'info');
        });

        return () => unsubscribe && unsubscribe();
      }, []);

      // æµ‹è¯•æ³¨å†Œ
      const testRegister = async () => {
        const email = prompt('è¯·è¾“å…¥é‚®ç®±:', 'test@example.com');
        const password = prompt('è¯·è¾“å…¥å¯†ç :', '123456');
        const nickname = prompt('è¯·è¾“å…¥æ˜µç§°:', 'æµ‹è¯•ç”¨æˆ·');
        
        if (!email || !password) return;

        try {
          const result = await window.authService.register(email, password, nickname);
          addLog(`æ³¨å†ŒæˆåŠŸ: ${result.user.email}`, 'success');
        } catch (err) {
          addLog(`æ³¨å†Œå¤±è´¥: ${err.message}`, 'error');
        }
      };

      // æµ‹è¯•ç™»å½•
      const testLogin = async () => {
        const email = prompt('è¯·è¾“å…¥é‚®ç®±:', 'test@example.com');
        const password = prompt('è¯·è¾“å…¥å¯†ç :', '123456');
        
        if (!email || !password) return;

        try {
          const result = await window.authService.login(email, password);
          setUser(result.user);
          addLog(`ç™»å½•æˆåŠŸ: ${result.user.email}`, 'success');
        } catch (err) {
          addLog(`ç™»å½•å¤±è´¥: ${err.message}`, 'error');
        }
      };

      // æµ‹è¯•ç™»å‡º
      const testLogout = async () => {
        try {
          await window.authService.logout();
          setUser(null);
          addLog('ç™»å‡ºæˆåŠŸ', 'success');
        } catch (err) {
          addLog(`ç™»å‡ºå¤±è´¥: ${err.message}`, 'error');
        }
      };

      // æµ‹è¯•è·å–æ‰€æœ‰ç”¨æˆ·
      const testGetAllUsers = async () => {
        try {
          const users = await window.authService.getAllUsers();
          addLog(`è·å–ç”¨æˆ·åˆ—è¡¨æˆåŠŸ: ${users.length}ä¸ªç”¨æˆ·`, 'success');
          console.log('ç”¨æˆ·åˆ—è¡¨:', users);
        } catch (err) {
          addLog(`è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${err.message}`, 'error');
        }
      };

      // æ¸…é™¤æ‰€æœ‰æ•°æ®
      const clearAllData = () => {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®å—ï¼Ÿ')) {
          localStorage.removeItem('dnd_users');
          localStorage.removeItem('dnd_current_user');
          localStorage.removeItem('dnd_auth_token');
          setUser(null);
          addLog('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'info');
        }
      };

      return (
        <div className="min-h-screen">
          {/* é¡¶éƒ¨å¯¼èˆª - æ¼”ç¤ºAuthBlock */}
          <nav className="bg-white shadow-sm">
            <div className="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
              <h1 className="text-xl font-bold text-gray-800">
                ğŸ” DND ç”¨æˆ·è®¤è¯æ¨¡å—æµ‹è¯•
              </h1>
              {/* AuthBlock ç»„ä»¶ */}
              <AuthBlock 
                config={{
                  showRegister: true,
                  showAvatar: true
                }}
              />
            </div>
          </nav>

          <div className="max-w-6xl mx-auto px-4 py-8">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              
              {/* å·¦ä¾§ï¼šæ“ä½œé¢æ¿ */}
              <div className="bg-white rounded-lg shadow p-6">
                <h2 className="text-lg font-bold mb-4 text-gray-800">API æµ‹è¯•</h2>
                
                {/* å½“å‰ç”¨æˆ·ä¿¡æ¯ */}
                <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                  <h3 className="font-medium text-gray-700 mb-2">å½“å‰ç”¨æˆ·</h3>
                  {user ? (
                    <div className="text-sm">
                      <p><strong>ID:</strong> {user.id}</p>
                      <p><strong>é‚®ç®±:</strong> {user.email}</p>
                      <p><strong>æ˜µç§°:</strong> {user.nickname}</p>
                      <p><strong>è§’è‰²:</strong> <span className={user.role === 'admin' ? 'text-red-500 font-bold' : ''}>{user.role}</span></p>
                    </div>
                  ) : (
                    <p className="text-gray-500 text-sm">æœªç™»å½•</p>
                  )}
                </div>

                {/* æ“ä½œæŒ‰é’® */}
                <div className="space-y-3">
                  <button
                    onClick={testRegister}
                    className="w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
                  >
                    ğŸ“ æµ‹è¯•æ³¨å†Œ
                  </button>
                  <button
                    onClick={testLogin}
                    className="w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                  >
                    ğŸ”‘ æµ‹è¯•ç™»å½•
                  </button>
                  <button
                    onClick={testLogout}
                    className="w-full py-2 px-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
                    disabled={!user}
                  >
                    ğŸšª æµ‹è¯•ç™»å‡º
                  </button>
                  <button
                    onClick={testGetAllUsers}
                    className="w-full py-2 px-4 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition"
                  >
                    ğŸ‘¥ è·å–æ‰€æœ‰ç”¨æˆ· (éœ€ç®¡ç†å‘˜)
                  </button>
                  <hr className="my-4" />
                  <button
                    onClick={clearAllData}
                    className="w-full py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                  >
                    ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®
                  </button>
                </div>

                {/* æ¨¡å¼åˆ‡æ¢ */}
                <div className="mt-6 p-4 bg-yellow-50 rounded-lg">
                  <h3 className="font-medium text-yellow-800 mb-2">å½“å‰æ¨¡å¼</h3>
                  <p className="text-sm text-yellow-700">
                    <strong>{window.authService.getMode()}</strong> 
                    {window.authService.getMode() === 'mock' && ' (æœ¬åœ°æ¨¡æ‹Ÿï¼Œæ•°æ®å­˜localStorage)'}
                  </p>
                </div>
              </div>

              {/* å³ä¾§ï¼šæ—¥å¿—é¢æ¿ */}
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold text-gray-800">æ“ä½œæ—¥å¿—</h2>
                  <button
                    onClick={() => setLogs([])}
                    className="text-sm text-gray-500 hover:text-gray-700"
                  >
                    æ¸…ç©º
                  </button>
                </div>
                
                <div className="bg-gray-900 rounded-lg p-4 h-96 overflow-auto font-mono text-sm">
                  {logs.length === 0 ? (
                    <p className="text-gray-500">æš‚æ— æ—¥å¿—</p>
                  ) : (
                    logs.map((log, index) => (
                      <div key={index} className={`mb-1 ${
                        log.type === 'error' ? 'text-red-400' :
                        log.type === 'success' ? 'text-green-400' :
                        'text-gray-300'
                      }`}>
                        <span className="text-gray-500">[{log.timestamp}]</span> {log.message}
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>

            {/* è¯´æ˜ */}
            <div className="mt-8 bg-blue-50 rounded-lg p-6">
              <h3 className="font-bold text-blue-800 mb-3">ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
              <ul className="text-sm text-blue-700 space-y-2">
                <li>â€¢ <strong>AuthBlockç»„ä»¶</strong>ï¼šå³ä¸Šè§’çš„ç™»å½•/æ³¨å†ŒæŒ‰é’®å³ä¸ºç”¨æˆ·è´¦å·åŒºå—</li>
                <li>â€¢ <strong>æ¨¡æ‹Ÿæ¨¡å¼</strong>ï¼šå½“å‰ä½¿ç”¨localStorageæ¨¡æ‹Ÿæ•°æ®åº“ï¼Œåˆ·æ–°é¡µé¢æ•°æ®ä¿ç•™</li>
                <li>â€¢ <strong>ç¬¬ä¸€ä¸ªæ³¨å†Œç”¨æˆ·</strong>ï¼šè‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜ï¼ˆadminè§’è‰²ï¼‰</li>
                <li>â€¢ <strong>ç®¡ç†å‘˜åŠŸèƒ½</strong>ï¼šå¯æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ã€åˆ é™¤ç”¨æˆ·ã€ä¿®æ”¹ç”¨æˆ·è§’è‰²</li>
                <li>â€¢ <strong>éƒ¨ç½²æ—¶</strong>ï¼šåˆ‡æ¢ä¸ºSupabaseæ¨¡å¼ï¼Œæ•°æ®å­˜äº‘ç«¯æ•°æ®åº“</li>
              </ul>
            </div>
          </div>
        </div>
      );
    }

    // æ¸²æŸ“åº”ç”¨
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TestApp />);
  </script>
</body>
</html>
