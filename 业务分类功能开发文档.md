# 业务分类功能开发文档

## 开发日期
2025-01-06

## 需求概述
在大系统中会用到非常多的字段，现有的字段列表难以查找。除了系统分类（字段角色、字段类型、字段性质）之外，增加"业务分类"选项，允许产品经理根据系统的业务属性对字段进行分类，方便查找和查看。

## 核心功能
1. **业务分类管理** - 创建、修改、删除业务分类
2. **字段关联分类** - 添加字段时选择业务分类
3. **多维度检索** - 支持按4个属性检索字段

## 实现内容

### 1. 数据库层面

#### 1.1 业务分类表（business_categories）
```javascript
{
  id: string           // 分类编号，系统自增（BCAT-001, BCAT-002...）
  name: string        // 分类名称，10汉字以内
  description: string  // 分类说明，200汉字以内
  project_id: string  // 所属项目ID
  created_at: timestamp
}
```

#### 1.2 字段表新增字段
```javascript
{
  businessCategoryId: string  // 业务分类ID，可为空
}
```

### 2. 数据库操作（supabaseDB.js）

#### 新增方法：
- `getBusinessCategoriesByProjectId(projectId)` - 获取项目的所有业务分类
- `addBusinessCategory(projectId, category)` - 添加业务分类
- `updateBusinessCategory(projectId, categoryId, updates)` - 更新业务分类
- `deleteBusinessCategory(projectId, categoryId)` - 删除业务分类
- `generateBusinessCategoryId(project)` - 生成业务分类ID

#### 修改方法：
- `_formatProject()` - 添加 businessCategories 字段
- `addProject()` - 创建项目时自动添加"系统字段"分类
- 添加系统字段时自动设置 businessCategoryId

### 3. 新增组件：BusinessCategoryManager.jsx

**功能特性**：
- ✅ 显示业务分类列表（表格形式）
- ✅ 新增分类（点击右上角+号）
- ✅ 修改分类名称和说明
- ✅ 删除分类（带验证）
- ✅ 分类编号系统自增
- ✅ 系统默认分类（BCAT-001）不可删除

**界面设计**：
```
┌─────────────────────────────────────────────┐
│  业务分类管理                      [+ 添加] │
├─────────────────────────────────────────────┤
│ 编号  │ 分类名称  │ 分类说明  │ 操作     │
├─────────────────────────────────────────────┤
│ BCAT-001 │ 系统字段 │ ...    │ 修改        │
│ BCAT-002 │ 基本信息 │ ...    │ 修改 删除 │
│ BCAT-003 │ 订单信息 │ ...    │ 修改 删除 │
└─────────────────────────────────────────────┘
```

**添加/编辑分类表单**：
- 分类名称（必填，10汉字以内）
- 分类说明（可选，200汉字以内）
- 实时字符计数

### 4. 修改组件：FieldDefinition.jsx

#### 4.1 导航栏修改
- 新增"业务分类"按钮（绿色）
- 点击后打开分类管理模态框

#### 4.2 检索区新增
在字段列表上方增加4个检索条件：
```
┌─────────────────────────────────────────────┐
│ [字段角色▼] [字段类型▼] [字段性质▼] [业务分类▼] [重置筛选] │
└─────────────────────────────────────────────┘
```

- **字段角色**：全部、主键、非主键
- **字段类型**：全部、字符串、整数、浮点数、逻辑、日期/时间、文件、富文本、JSON
- **字段性质**：全部、基础字段、衍生字段、属性字段
- **业务分类**：全部、动态加载所有业务分类

#### 4.3 字段列表修改
新增"业务分类"列（在"字段性质"和"约束"之间）

显示逻辑：
- 已分类：显示分类名称（橙色标签）
- 未分类：显示"未分类"（灰色文字）

#### 4.4 添加/编辑字段表单修改
在"字段性质"之后新增"业务分类"选择：

```javascript
{
  name: '',
  role: '非主键',
  type: '字符串',
  length: '',
  unique: false,
  nature: '基础字段',
  businessCategoryId: ''  // 新增
}
```

选项：
- 默认："请选择业务分类"
- 列表：动态加载所有业务分类

### 5. 数据初始化

#### 5.1 项目创建时
- 自动创建"系统字段"业务分类（BCAT-001）
- 分类名称：系统字段
- 分类说明：系统内置字段，不可删除

#### 5.2 系统字段初始化
- 所有系统字段（用户管理表）的 businessCategoryId 自动设置为 BCAT-001
- 包括：用户ID、账号、密码、昵称、头像、角色、状态、注册时间、最后登录

## 文件修改清单

### 新增文件
- ✅ `src/components/BusinessCategoryManager.jsx` - 业务分类管理组件

### 修改文件
- ✅ `src/utils/supabaseDB.js` - 数据库操作方法
  - 新增业务分类CRUD方法
  - 修改 _formatProject 方法
  - 修改 addProject 方法
- ✅ `src/components/FieldDefinition.jsx` - 字段定义组件
  - 新增业务分类状态
  - 新增检索条件
  - 新增业务分类列
  - 新增业务分类选择
  - 新增业务分类管理模态框
- ✅ `index.html` - 加载新组件

## 数据流示意图

```
创建项目
  ↓
自动创建"系统字段"分类（BCAT-001）
  ↓
创建系统字段
  ↓
自动关联到"系统字段"分类
  ↓
  字段列表显示"系统字段"标签
  ↓
  用户可以添加自定义分类
  ↓
  为新字段选择分类
  ↓
  按分类检索字段
```

## 删除分类验证逻辑

```javascript
async deleteBusinessCategory(projectId, categoryId) {
  // 1. 获取项目的所有字段
  const fields = await getFieldsByProjectId(projectId);

  // 2. 检查是否有字段使用该分类
  const usedFields = fields.filter(f => f.businessCategoryId === categoryId);

  // 3. 如果有字段使用，抛出错误
  if (usedFields.length > 0) {
    throw new Error(`该分类下有 ${usedFields.length} 个字段正在使用，无法删除`);
  }

  // 4. 删除分类
  await updateProject({ ...project, businessCategories: filteredCategories });
}
```

## 系统默认分类

### BCAT-001 - 系统字段
- **不可删除**：代码中硬编码判断
- **系统字段**：自动关联
  - SYS-FLD-001 用户ID
  - SYS-FLD-002 账号
  - SYS-FLD-009 密码
  - SYS-FLD-003 昵称
  - SYS-FLD-004 头像
  - SYS-FLD-005 角色
  - SYS-FLD-006 状态
  - SYS-FLD-007 注册时间
  - SYS-FLD-008 最后登录

## 使用示例

### 场景1：添加新分类
1. 进入字段定义页面
2. 点击"业务分类"按钮
3. 点击右上角"+ 添加"
4. 输入分类名称（如"订单信息"）
5. 输入分类说明（如"订单相关字段"）
6. 点击"确认提交"

### 场景2：创建字段并分类
1. 进入字段定义页面
2. 点击"+ 添加新字段"
3. 填写字段名称、类型等
4. 在"业务分类"下拉菜单选择"订单信息"
5. 点击"确认提交"
6. 字段列表中该字段显示"订单信息"标签

### 场景3：按分类检索字段
1. 进入字段定义页面
2. 在"业务分类"下拉菜单选择"订单信息"
3. 字段列表只显示属于该分类的字段
4. 可配合其他检索条件组合使用

### 场景4：修改分类
1. 点击"业务分类"按钮
2. 在分类列表中点击"修改"
3. 修改名称或说明
4. 点击"确认提交"

### 场景5：删除分类
1. 点击"业务分类"按钮
2. 点击"删除"按钮
3. 系统检查是否有字段使用
  - 如果有：提示"该分类下有X个字段正在使用，无法删除"
  - 如果没有：确认删除

## 兼容性说明

### 向后兼容
- ✅ 现有字段的 businessCategoryId 默认为空
- ✅ 检索时选择"全部"可显示所有字段
- ✅ 不选择业务分类也能创建字段

### 新项目
- ✅ 自动创建"系统字段"分类
- ✅ 系统字段自动关联到该分类

### 现有项目
- ⚠️ 业务分类列表为空（不自动创建）
- ⚠️ 系统字段的 businessCategoryId 保持为空
- ✅ 用户可以手动创建分类并关联

## 技术特点

### ID生成规则
- **业务分类**：BCAT-001, BCAT-002, ...
- **字段**：FLD-001, FLD-002, ...

### 验证规则
- 分类名称：必填，≤10汉字
- 分类说明：可选，≤200汉字
- 删除：检查是否有字段使用

### UI特性
- ✅ 响应式布局
- ✅ 表格带斑马纹
- ✅ 标签颜色区分
- ✅ 实时字符计数
- ✅ 空状态提示
- ✅ 模态框居中显示

## 测试清单

### 基础功能
- [ ] 创建新项目时自动生成"系统字段"分类
- [ ] 系统字段自动关联到"系统字段"分类
- [ ] 打开业务分类管理页面
- [ ] 添加新业务分类
- [ ] 修改业务分类
- [ ] 删除业务分类（无使用）
- [ ] 删除业务分类（有使用）应提示错误

### 字段功能
- [ ] 添加字段时选择业务分类
- [ ] 编辑字段时显示当前业务分类
- [ ] 字段列表显示业务分类列
- [ ] 按业务分类检索字段
- [ ] 按多维度组合检索字段
- [ ] 重置检索条件

### 边界情况
- [ ] 分类名称为空时不能提交
- [ ] 分类名称超过10字时提示
- [ ] 分类说明超过200字时提示
- [ ] "系统字段"分类不能删除
- [ ] 未分类字段显示"未分类"标签

## 优化建议

### 短期优化（可选）
1. 批量修改字段分类
2. 复制分类
3. 分类排序功能
4. 分类图标设置

### 中期优化（可选）
1. 分类树形结构（父子分类）
2. 继承分类功能
3. 分类统计（显示每个分类下的字段数量）

## 版本记录

### v1.0.0（2025-01-06）
- ✅ 业务分类管理功能完整实现
- ✅ 字段关联分类功能实现
- ✅ 多维度检索功能实现
- ✅ 数据初始化逻辑实现
- ✅ 兼容性保证

---

**功能开发完成！** 🎉
